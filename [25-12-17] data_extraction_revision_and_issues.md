# 데이터 추출 재조정 및 실행 시 문제점 정리

``데이터 추출 시에 정답값인 steer와 spin 값을 바퀴마다 나눈 것이 아닌 앞쪽(steer), 뒤쪽(spin) 두 개로 나누어 추출하였음(아래 추출 방법 정리). 그렇게 추출하였는데도 불구하고 제네시스에서 실행하였을 때 결과가 블렌더와 일치하지 않아 데이터 추출 자체가 처음부터 잘못되었는지 아닌지를 판단하였음. ``

https://github.com/user-attachments/assets/4f5e528d-7825-4a63-90e7-c36d1db0c758

![alt text](images/data.path.png)

데이터를 뽑은 blender 영상과 그 뽑은 데이터를 통해 경로를 그린 결과가 매우 유사하였음  
`-> 데이터 추출은 문제가 없다 판단. `

위와 같은 판단으로 `정답값과 mlp` 둘 중 하나가 문제가 있다고 생각하였음. 그래서 아래에 정답값 추출 방법과 그 정답값 중 하나에 문제가 있다고 판단해 정리하였고, 정답값을 다른 걸로 바꾸어 실행보았음(spin -> 선속도)

https://github.com/user-attachments/assets/4c459550-3249-4b80-b4d6-9a1ec3834485

위와 같은 방법(정답값을 바꾸는 방법)으로 실행하였음에도 제네시스에서의 실행 결과가 처음에는 천천히 조금 좌회전하다 멈춤. (아래 정리)  
``-> 정답값과 mlp 중 정확한 문제점을 찾지 못함 ``



## 1. 조향각(Steer) 데이터 추출 방법

차량의 조향각은 차량 바디의 진행 방향과 앞바퀴의 진행 방향 사이의 상대적인 yaw 각도를 이용하여 계산하였다. 각 앞바퀴의 조향각을 개별적으로 계산한 뒤, 이를 평균하여 **앞바퀴 전체를 대표하는 단일 조향값(steer)**으로 정의함.

### 1.1 앞바퀴 조향각 계산

차량 바디의 전방 방향 벡터를 계산함.
```python
body_fwd = R_body @ BLENDER_FORWARD_LOCAL
```

- `body_fwd`: 차량 바디의 월드 좌표계 기준 전방 진행 방향 벡터
- `R_body`: 차량 바디의 월드 좌표계 기준 회전 행렬
- `BLENDER_FORWARD_LOCAL`: Blender 로컬 좌표계에서 정의된 전방 방향 벡터 (−Y 방향)

각 앞바퀴(좌·우)에 대해, 바퀴의 전방 방향 벡터를 계산함.
```python
wheel_fwd = R_wheel @ BLENDER_FORWARD_LOCAL
```

- `wheel_fwd`: 해당 앞바퀴의 월드 좌표계 기준 전방 방향 벡터
- `R_wheel`: 앞바퀴 오브젝트의 월드 좌표계 기준 회전 행렬

차량 바디 전방 벡터와 바퀴 전방 벡터 사이의 부호 있는 yaw 각도를 계산함.
```python
signed_yaw(body_fwd, wheel_fwd)
```

- `body_fwd`: 차량 바디의 전방 방향 벡터
- `wheel_fwd`: 앞바퀴의 전방 방향 벡터
- `signed_yaw(·)`: 두 벡터 사이의 부호 있는 yaw 각도를 계산하는 함수

이때 벡터 외적의 z 성분을 이용하여 회전 방향(좌/우)을 구분하고, 조향각 범위를 [-π/2, π/2]로 제한함.

### 1.2 좌·우 앞바퀴 조향각 통합

좌측 및 우측 앞바퀴에 대해 계산된 조향각을 평균하여, 하나의 조향값으로 통합함.
```python
steer = 0.5 * (steer_L + steer_R)
```

- `steer_L`, `steer_R`: 좌·우 앞바퀴에서 각각 계산된 조향각
- `steer`: 앞바퀴 전체를 대표하는 단일 조향값

**설계 의도**
- 좌·우 앞바퀴는 동일한 조향 명령을 수행
- 바퀴별 조향값을 그대로 사용하면 불필요한 자유도가 증가
- 앞바퀴 전체를 대표하는 단일 조향값이 제어 및 학습에 더 적합

최종적으로 해당 값은 CSV의 `steer` 컬럼으로 저장됨.

## 2. 후륜 회전(Spin_rear) 데이터 추출 방법

차량은 후륜구동(RWD) 구조이므로, 구동 상태를 표현하기 위해 뒷바퀴의 회전 정보만을 사용하였다. 좌·우 뒷바퀴의 회전량을 각각 계산한 뒤, 이를 평균하여 **후륜 전체를 대표하는 단일 회전값(spin_rear)**으로 정의함.

### 2.1 뒷바퀴 회전량 계산

각 뒷바퀴에 대해, 연속된 프레임 간 회전 quaternion의 변화량을 이용해 회전 속도를 계산하였다.

- 이전 프레임과 현재 프레임의 회전 quaternion을 비교
- 상대 회전에서 회전 각도(angle)와 회전축(axis)을 추출
- 바퀴의 실제 회전축 방향과 일치하는 성분만 투영하여 spin 성분 계산
```python
spin_rate = axis.dot(spin_axis_world) * angle / dt
```

- `spin_rate`: 바퀴의 실제 구름에 해당하는 회전 속도
- `axis`: 프레임 간 상대 회전의 회전축
- `spin_axis_world`: 월드 좌표계 기준 바퀴 회전축 방향
- `angle`: 프레임 간 회전 각도
- `dt`: 프레임 간 시간 간격

이를 통해 바퀴의 진행 방향 회전에 해당하는 성분만을 추출함.

### 2.2 좌·우 뒷바퀴 회전 통합

좌·우 뒷바퀴에서 계산된 회전 속도를 평균하여, 하나의 후륜 회전값으로 통합함.
```python
spin_rear = 0.5 * (spin_RL + spin_RR)
```

- `spin_RL`, `spin_RR`: 좌·우 뒷바퀴의 회전 속도
- `spin_rear`: 후륜 전체를 대표하는 단일 회전값

**설계 의도**
- 좌·우 뒷바퀴는 동일한 구동 명령을 받음
- 바퀴별 회전값을 그대로 사용할 경우 노이즈 및 상쇄 문제 발생 가능
- 후륜 전체를 대표하는 단일 구동 지표가 학습에 더 안정적

해당 값은 CSV의 `spin_rear` 컬럼으로 저장됨.

## 3. MLP 출력(Action) 및 정답값 정의

앞서 추출한 조향각 및 후륜 회전 데이터를 바탕으로, 행동 클로닝을 위한 MLP 모델의 출력(action)을 2차원 벡터로 정의함.
```python
action = [steer, throttle]
```

### 3.1 Steer (조향)

- 1절에서 추출한 CSV 파일의 `steer` 값을 정규화하여 사용
- 앞바퀴 전체를 대표하는 단일 조향 명령
- 차량의 회전 거동을 직접적으로 반영

### 3.2 Throttle (Spin 대체)

초기 설계에서는 2절에서 추출한 CSV의 `spin_rear` 값을 throttle로 사용하였으나, 최종 학습 코드에서는 차량의 실제 전진 거동을 더 잘 반영하기 위해 전진 선속도(`g_lin_vx`)를 throttle의 대리 변수로 사용하였다.
```python
throttle_norm = lin_vx / vx_max
```

**변경 이유**
- 좌·우 바퀴의 spin 값은 상황에 따라 상쇄될 수 있음
- 바퀴 slip, 접지 변화 등으로 인해 실제 차량 진행과 직접적으로 대응되지 않는 경우 존재
- 전진 선속도는 차량의 종방향 거동을 가장 직접적으로 나타내는 물리량

이를 통해 학습 시 보다 안정적이고 물리적으로 타당한 행동 표현이 가능함.